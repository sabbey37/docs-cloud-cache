---
title: Preparing for Transport Layer Security (TLS)
---

This topic describes how to provide an existing Certificate Authority (CA)
certificate to [BOSH CredHub](https://docs.pivotal.io/tiledev/credhub.html) and how to generate a new CA
certificate with BOSH CredHub, if you do not already have one.

<p class="note warning"><strong>WARNING</strong>: This procedure involves restarting all of the VMs in an existing PCF deployment in order to propagate a CA certificate. The operation can take a long time to complete.</p>

##<a id='overview'></a> Overview

Enabling TLS provisions PCC service instances with a certificate,
so that apps, gfsh, and Pulse can establish encrypted connections
with the PCC service instance.

The certificate deployed on the PCC service instance is a
**server certificate**.
The server certificate is generated by **CredHub**, a component designed for centralized credential management in PCF.
**CredHub** is deployed on the same VM as the BOSH Director.

CredHub generates the server certificate using a **Certificate Authority (CA) certificate**.
The CA certificate must be provided to CredHub by the operator or generated by CredHub.

Apps use the CA certificate to authenticate components of PCC service instances.
Apps that communicate with PCC must have access to the CA certificate
in order to validate that the server certificate can be trusted.

<p class="note warning"><strong>WARNING</strong>: An operator must rotate the CA certificate if it expires or if it becomes compromised.
To rotate your CA certificate, see <a href="rotating-ca.html">Managing Certificates</a>.
Do not attempt to rotate a CA certificate on your own.
Contact <a href="https://support.pivotal.io">Pivotal Support</a> and perform the procedure with their assistance.</p>

##<a id="provide-generate-pcf"></a> Provide or Generate a CA Certificate

TLS authorization requires a credential generated by CredHub. You do not need to create a new User
Account and Authentication (UAA) client for CredHub specifically to support TLS, as long as a UAA
Client exists with `credhub.write` and `credhub.read` permissions. The client used in this section is one that
was created during the OpsManager installation process: the `ops_manager` client. 

However, in cases where you would like to trace certificate access specifically to CredHub, you may
choose to create another client just for TLS setup: follow the instructions in [Creating UAA Clients
for BOSH Director](https://docs.pivotal.io/pivotalcf/2-4/customizing/opsmanager-create-bosh-client.html) 
in the PCF documentation. The client you create must have `credhub.read` and `credhub.write` permissions.
Once that client is established, resume this procedure using that client in place of the `ops_manager` client used here.

###<a id='add-ca-cert'></a> Add the CA Certificate

Perform the following steps to log in to CredHub, provide or generate a CA certificate, and add the certificate to Ops Manager:

1. From the Ops Manager VM, set the API target of the CredHub CLI to your CredHub server.
    <br><br>
    Run the following command:

    ```
    credhub api https://BOSH-DIRECTOR:8844 --ca-cert=/var/tempest/workspaces/default/root_ca_certificate
    ```
    <br>
    where `BOSH-DIRECTOR` is the IP address of the BOSH Director VM.
    <br><br>
    For example:
    <pre class="terminal">
    $ credhub api http<span>s:</span>//10.0.0.5:8844 --ca-cert=/var/tempest/workspaces/default/root_ca_certificate
    </pre>

1. Log in to CredHub.
    <br><br>
    Run the following command:

    ```
    credhub login --client-name=CLIENT-NAME --client-secret=CLIENT-SECRET
    ```
    <br>
    where `CLIENT-NAME` is the client name, usually `ops_manager` or a CredHub-specific UAA client of your own creation, and
    `CLIENT-SECRET` is the client secret which can be found under the Credentials tab of the OpsManager tile with the name `Bosh Commandline Credentials`.
    <br><br>
    For example:
    <pre class="terminal">
    $ credhub login \
    	--client-name=ops_manager \
    	--client-secret=abcdefghijklm123456789
    </pre>

1. Use the CredHub CLI to check whether a services CA certificate already is present.
  <br><br>
  * Enter the following command:
    <pre class="terminal">
    $ credhub get \
			 --name="/services/tls_ca"
    </pre>
  * If you already have a certificate at the `services/tls_ca` path, skip to step 5.

1. Use the CredHub CLI to generate a CA certificate or provide an existing one.
    <p class="note"><strong>Note</strong>: Your PCF deployment may have multiple CA certificates.
       Pivotal recommends a dedicated CA certificate for services.</p>
	* If you do not have a CA certificate, use the CredHub CLI to generate one.
          Enter the following command:
		<pre class="terminal">
		$ credhub generate \
			--name="/services/tls_ca" \
			--type="certificate" \
			--no-overwrite \
			--is-ca \
            --common-name="rootCA"
		</pre>
    * If you have an existing CA certificate that you want to use, create a new file called `root.pem` with the contents of the certificate.
      Then enter the following command, specifying the path to `root.pem` and the private key for the certificate:
        <pre class="terminal">
        $ credhub set \
            --name="/services/tls_ca" \
            --type="certificate" \
            --certificate=./root.pem \
            --private=ERKSOSMFF...
        </pre>

1. Use the BOSH CLI v2 to extract the `certificate` portion from the CA certificate and print it.
    Enter the following command:
    <pre class="terminal">
    $ bosh2 interpolate <(credhub get --name=/services/tls_ca) \
    --path /value/certificate
    </pre>
1. Record the output of the `bosh2 interpolate` command from step 5.
1. Navigate to the Ops Manager **Installation Dashboard** and select the Ops Manager Director tile.
Click **Security**.
1. Paste the contents of the CA certificate into **Trusted Certificates**.
Append to existing **Trusted Certificates**,
if there are already certificates listed.
Click **Save**.
1. The CA certificate must also be added for the Gorouter.
Navigate to the PAS **Settings** tab.
Click on **Networking**.
Add the CA certificate to the box labeled **Certificate Authorities Trusted by Router and HAProxy** and click **Save**.
1.  Click **Review Pending Changes** (see [Reviewing Pending Product Changes](https://docs.pivotal.io/pivotalcf/customizing/review-pending-changes.html)).
1.  Click **Apply Changes**.
